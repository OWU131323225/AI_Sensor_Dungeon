<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sensor Dungeon</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-overlay"></div> 
    
    <div class="main-frame">
        <header class="game-header">
            <h1>AI SENSOR DUNGEON</h1>
            <div id="turn-display" class="turn-badge">Turn: 1 / 10</div>
        </header>

        <main class="game-console">
            <div class="screen-frame">
                <div id="story-area" class="story-log">
                    <p class="system-msg">
                        å¤ã„éºè·¡ã®å…¥ã‚Šå£ã«ç«‹ã£ã¦ã„ã‚‹...ã€‚<br>
                        å³ã®ã€Œé­”æ³•é™£ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‹ã‚‰ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã›ã‚ˆã€‚
                    </p>
                </div>
            </div>

            <div class="controls-area">
                <div class="radar-container">
                    <div class="radar-lines"></div>
                    <div id="dot" class="radar-blip"></div>
                </div>
                
                <div class="status-panel">
                    <div class="qr-wrapper">
                        <p class="qr-label">â–¼ LINK WEAPON â–¼</p>
                        <div id="qrcode"></div>
                    </div>

                    <div id="log" class="action-log">STANDBY...</div>
                    
                    <button id="reset-btn" onclick="resetGame()">ğŸ”„ RESTART</button>
                </div>
            </div>
        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isProcessing = false; 
        let chatHistory = []; 
        
        let currentTurn = 1;
        const MAX_TURNS = 10; 
        let isGameOver = false;

        let currentThemeData = null; 
        let lastActionDirection = "";
        let isBattleMode = false;

        let battleCount = 0;       
        const MAX_BATTLES = 2;     
        let battleTurnCount = 0;   

        // ãƒ†ãƒ¼ãƒã¨ã‚¨ãƒªã‚¢ã®å®šç¾©
        const THEME_LIST = [
            {
                name: "æ°·çµã®å±±è„ˆ",
                zones: ["å¹é›ªãç™»å±±å£ï¼ˆè¦–ç•Œä¸è‰¯ï¼‰", "é€ãé€šã‚‹æ°·ã®æ´çªŸï¼ˆå¯’ã•ã¨ç¾ã—ã•ï¼‰", "å¤ä»£ã®æ°·å£éºè·¡ï¼ˆäººå·¥ç‰©ï¼‰", "å±±é ‚ã®ç¥­å£‡ï¼ˆç©ºãŒè¿‘ã„ï¼‰"]
            },
            {
                name: "æ·±æ·µã®æ£®",
                zones: ["å…‰ã‚‹ã‚­ãƒã‚³ã®å¯†æ—ï¼ˆå¹»æƒ³çš„ï¼‰", "è…æ•—ã—ãŸé»’ã„æ²¼åœ°ï¼ˆæ‚ªè‡­ã¨æ³¥ï¼‰", "å·¨æœ¨ã«çµ¡ã¾ã‚ŒãŸçŸ³é€ ã‚Šã®å»ƒå¢Ÿï¼ˆè‹”ã¨çŸ³ï¼‰", "æ£®ã®ä¸»ãŒä½ã‚€å·¨å¤§ãªå·£ï¼ˆéª¨ã¨ç²˜æ¶²ï¼‰"]
            },
            {
                name: "æ©Ÿæ¢°ä»•æ›ã‘ã®å¡”",
                zones: ["è’¸æ°—ãŒå¹ãå‡ºã™ä¸‹å±¤ï¼ˆé…ç®¡ã¨éŒ†ï¼‰", "æ­¯è»ŠãŒè½Ÿãä¸­å±¤å·¥å ´ï¼ˆæ²¹ã®åŒ‚ã„ï¼‰", "é™è¬ãªæ™‚è¨ˆå¡”å†…éƒ¨ï¼ˆã‚«ãƒã‚³ãƒéŸ³ï¼‰", "æœ€ä¸Šéšã®åˆ¶å¾¡å®¤ï¼ˆé›»æ°—ã¨ã‚¬ãƒ©ã‚¹ï¼‰"]
            },
            {
                name: "ç ‚æ¼ ã®å¤§éœŠå»Ÿ",
                zones: ["ç†±é¢¨ãŒèˆã†ç ‚ä¸˜ã®å…¥ã‚Šå£", "åœ°ä¸‹ã¸ã¨ç¶šãæš—ã„å›å»Šï¼ˆä¹¾ç‡¥ï¼‰", "é»„é‡‘ã®è£…é£¾ãŒæ®‹ã‚‹ç‹ã®é–“", "å‘ªã‚ã‚ŒãŸæœ€æ·±éƒ¨ã®ç„å®¤"]
            },
            {
                name: "æ°´æ²¡éƒ½å¸‚",
                zones: ["çŠç‘šã«è¦†ã‚ã‚ŒãŸæµ…ç€¬ã®å»ƒãƒ“ãƒ«", "æ·±æµ·ã®æš—ã„å•†åº—è¡—ï¼ˆé­šã®éª¨ï¼‰", "å·¨å¤§ãªæ²ˆæ²¡èˆ¹ã®å†…éƒ¨ï¼ˆé‰„éŒ†ï¼‰", "æµ·åº•ç¥æ®¿ã®å…¥ã‚Šå£"]
            }
        ];

        window.onload = function() {
            const smartUrl = window.location.origin + "/smart.html";
            new QRCode(document.getElementById("qrcode"), {
                text: smartUrl,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        };

        socket.emit('join', 'game');

        socket.on('sensor_update', (data) => {
            updateVisual(data.b, data.g);
            checkAction(data.b, data.g);
        });

        function updateVisual(beta, gamma) {
            const dot = document.getElementById('dot');
            let moveY = beta * 2.5; 
            let moveX = gamma * 2.5;
            const limit = 90;
            moveX = Math.max(-limit, Math.min(limit, moveX));
            moveY = Math.max(-limit, Math.min(limit, moveY));
            dot.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        }

        function checkAction(beta, gamma) {
            if (isProcessing || isGameOver) return; 

            const THRESHOLD = 20; 
            let action = "";

            if (beta < -THRESHOLD) action = "åŒ—ï¼ˆå¥¥ï¼‰";
            else if (beta > THRESHOLD) action = "å—ï¼ˆæ‰‹å‰ï¼‰";
            else if (gamma > THRESHOLD) action = "æ±ï¼ˆå³ï¼‰";
            else if (gamma < -THRESHOLD) action = "è¥¿ï¼ˆå·¦ï¼‰";

            const logEl = document.getElementById('log');
            
            if (action) {
                let displayAction = action;
                if (isBattleMode) {
                    if (action.includes("åŒ—")) displayAction = "âš”ï¸ æ”»æ’ƒ (ATTACK)";
                    else if (action.includes("å—")) displayAction = "ğŸ’¨ é€ƒèµ° (ESCAPE)";
                    else displayAction = "ğŸ›¡ï¸ å›é¿ (DODGE)";
                    logEl.style.color = "#ff4444"; 
                } else {
                    if (action.includes("åŒ—")) displayAction = "åŒ—ã¸é€²ã‚€";
                    else if (action.includes("å—")) displayAction = "å—ã¸æˆ»ã‚‹";
                    else if (action.includes("æ±")) displayAction = "æ±ã¸é€²ã‚€";
                    else displayAction = "è¥¿ã¸é€²ã‚€";
                    logEl.style.color = "#00ffea"; 
                }

                logEl.innerText = `>> ${displayAction}`;
                logEl.classList.add('active');
                if (!this.holdTimer) {
                    this.holdTimer = setTimeout(() => {
                        sendToAI(action); 
                        this.holdTimer = null;
                    }, 1000);
                }
            } else {
                if (this.holdTimer) {
                    clearTimeout(this.holdTimer);
                    this.holdTimer = null;
                    logEl.innerText = isBattleMode ? "BATTLE MODE..." : "STANDBY...";
                    logEl.classList.remove('active');
                }
            }
        }

        function scrollToBottom() {
            const storyDiv = document.getElementById('story-area');
            storyDiv.scrollTop = storyDiv.scrollHeight;
        }

        async function sendToAI(rawAction) {
            isProcessing = true;
            const storyDiv = document.getElementById('story-area');
            const logEl = document.getElementById('log');
            
            logEl.innerText = "FATE WEAVING...";
            logEl.classList.add('loading');
            
            let displayActionText = "";
            if (isBattleMode) {
                 if (rawAction.includes("åŒ—")) displayActionText = "âš”ï¸ æ•µã«æ”»æ’ƒã‚’ä»•æ›ã‘ã‚‹ï¼";
                 else if (rawAction.includes("å—")) displayActionText = "ğŸ’¨ æ•µã‹ã‚‰é€ƒèµ°ã‚’å›³ã‚‹ï¼";
                 else displayActionText = "ğŸ›¡ï¸ æ•µã®æ”»æ’ƒã‚’å›é¿ã™ã‚‹ï¼";
            } else {
                 if (rawAction.includes("åŒ—")) displayActionText = "åŒ—ï¼ˆå¥¥ï¼‰ã¸é€²ã‚€";
                 else if (rawAction.includes("å—")) displayActionText = "å—ï¼ˆæ‰‹å‰ï¼‰ã¸æˆ»ã‚‹";
                 else if (rawAction.includes("æ±")) displayActionText = "æ±ï¼ˆå³ï¼‰ã¸é€²ã‚€";
                 else displayActionText = "è¥¿ï¼ˆå·¦ï¼‰ã¸é€²ã‚€";
            }

            storyDiv.innerHTML += `<div class="user-action">> ${displayActionText}</div>`;
            scrollToBottom();

            // æ–‡è„ˆã¨ãƒ†ãƒ¼ãƒ
            let lastStory = "";
            if (chatHistory.length === 0) {
                currentThemeData = THEME_LIST[Math.floor(Math.random() * THEME_LIST.length)];
                lastStory = `æ°—ãŒã¤ãã¨ã€ã‚ãªãŸã¯ã€${currentThemeData.name}ã€ã®å…¥ã‚Šå£ï¼ˆ${currentThemeData.zones[0]}ï¼‰ã«ç«‹ã£ã¦ã„ãŸã€‚`;
            } else {
                const lastModelPart = chatHistory[chatHistory.length - 1];
                if (lastModelPart.role === "model") {
                    lastStory = lastModelPart.parts[0].text;
                }
            }

            // ã‚¾ãƒ¼ãƒ³è¨ˆç®—
            let zoneIndex = 0;
            if (currentTurn >= 10) zoneIndex = 3;
            else if (currentTurn >= 7) zoneIndex = 2;
            else if (currentTurn >= 4) zoneIndex = 1;
            
            let currentZoneName = currentThemeData.zones[zoneIndex];
            let prevZoneName = (zoneIndex > 0) ? currentThemeData.zones[zoneIndex - 1] : "";
            
            let zoneChangeInstruction = "";
            if (currentTurn === 4 || currentTurn === 7 || currentTurn === 10) {
                zoneChangeInstruction = `â˜…é‡è¦ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä»Šã€æ–°ã—ã„ã‚¨ãƒªã‚¢ã€${currentZoneName}ã€ã«è¶³ã‚’è¸ã¿å…¥ã‚Œã¾ã—ãŸã€‚ä»¥å‰ã®ã€${prevZoneName}ã€ã¨ã¯æ™¯è‰²ã‚„åŒ‚ã„ãŒã‚¬ãƒ©ãƒªã¨å¤‰ã‚ã£ãŸã“ã¨ã‚’å¼·èª¿ã—ã¦æå†™ã—ã¦ãã ã•ã„ã€‚å‰ã®ã‚¨ãƒªã‚¢ã®ç‰¹å¾´ã¯ã‚‚ã†æå†™ã—ãªã„ã§ãã ã•ã„ã€‚`;
            } else {
                zoneChangeInstruction = `ç¾åœ¨ã®å ´æ‰€ã¯ã€${currentZoneName}ã€ã§ã™ã€‚ã“ã®å ´æ‰€ç‰¹æœ‰ã®æ™¯è‰²ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚`;
            }

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ„å›³
            let playerIntent = "";
            let currentDirection = ""; 

            if (isBattleMode) {
                if (rawAction.includes("åŒ—")) playerIntent = "ã€æ”»æ’ƒã€‘ä¸€ã‹å…«ã‹ã€æ•µã«è‡´å‘½å‚·ã‚’ä¸ãˆã‚‹ã¤ã‚‚ã‚Šã§æ”»ã‚ã‚‹ã€‚";
                else if (rawAction.includes("å—")) playerIntent = "ã€é€ƒèµ°ã€‘æˆ¦æ³ä¸åˆ©ã¨åˆ¤æ–­ã—ã€å…¨åŠ›ã§ãã®å ´ã‹ã‚‰é›¢è„±ã™ã‚‹ã€‚";
                else playerIntent = "ã€å›é¿ã€‘æ•µã®æ”»æ’ƒã‚’è¦‹åˆ‡ã‚Šã€æ™‚é–“ã‚’ç¨¼ãã€‚";
            } else {
                if (rawAction.includes("åŒ—")) {
                    playerIntent = "ã€çªç ´ã€‘å¥¥ã¸é€²ã‚€ã€‚";
                    currentDirection = "åŒ—";
                } else if (rawAction.includes("å—")) {
                    playerIntent = "ã€å¾Œé€€ã€‘æˆ»ã‚‹ã€ã¾ãŸã¯è­¦æˆ’ã™ã‚‹ã€‚";
                    currentDirection = "å—";
                } else if (rawAction.includes("æ±")) {
                    playerIntent = "ã€æ¢ç´¢ã€‘å³ã¸é€²ã‚€ã€‚";
                    currentDirection = "æ±";
                } else {
                    playerIntent = "ã€æ¢ç´¢ã€‘å·¦ã¸é€²ã‚€ã€‚";
                    currentDirection = "è¥¿";
                }
            }

            // æ¥ç¶šè©
            let transitionInstruction = "";
            if (!isBattleMode) {
                if (chatHistory.length === 0) transitionInstruction = "ç‰©èªã®æ›¸ãå‡ºã—ã§ã™ã€‚";
                else if (currentDirection === lastActionDirection) transitionInstruction = "å‰å›ã¨åŒã˜æ–¹å‘ã¸ã®ç§»å‹•ã§ã™ã€‚ã€Œã•ã‚‰ã«å¥¥ã¸ã€ã€Œä¾ç„¶ã¨ã—ã¦ã€ãªã©ã§è‡ªç„¶ã«ç¹‹ã’ã¦ãã ã•ã„ã€‚";
                else transitionInstruction = "å‰å›ã¨ã¯é•ã†æ–¹å‘ã¸ã®ç§»å‹•ã§ã™ã€‚ã€Œæ–¹å‘ã‚’å¤‰ãˆã€ã€Œå’„å—Ÿã«æ¨ªã¸ã€ãªã©ã§å ´é¢è»¢æ›ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚";
                lastActionDirection = currentDirection;
            }

            if (chatHistory.length > 6) chatHistory = chatHistory.slice(-6);

            // --- â˜…ä¿®æ­£ï¼šãƒãƒˆãƒ«ç™ºç”Ÿãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæœ€ä½ä¿è¨¼ä»˜ãï¼‰ ---
            let encounterInstruction = "";
            if (!isBattleMode) {
                // æ¡ä»¶1: ã¾ã æœ€å¤§å›æ•°æˆ¦ã£ã¦ã„ãªã„
                if (battleCount < MAX_BATTLES) {
                     // æ¡ä»¶2: 9ã‚¿ãƒ¼ãƒ³ç›®ã«ãªã£ã¦ã‚‚ä¸€åº¦ã‚‚æˆ¦ã£ã¦ãªã„ãªã‚‰å¼·åˆ¶ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆï¼ˆè¦‹ã›å ´ã‚’ä½œã‚‹ï¼‰
                     if (currentTurn === 9 && battleCount === 0) {
                        encounterInstruction = "â˜…é‡è¦æŒ‡ç¤ºï¼šã€ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ç™ºç”Ÿã€‘çªå¦‚ã¨ã—ã¦ã“ã®ã‚¨ãƒªã‚¢ã®ä¸»ï¼ˆãƒœã‚¹ï¼‰ãŒç¾ã‚Œã¾ã—ãŸï¼å¼·åˆ¶çš„ã«æˆ¦é—˜ã«çªå…¥ã—ã¾ã™ã€‚æ–‡æœ«ã«å¿…ãšã€[BATTLE_START]ã€ã¨å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚";
                     }
                     // æ¡ä»¶3: 4ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ã€20%ã®ç¢ºç‡ã§ãƒ©ãƒ³ãƒ€ãƒ ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ãƒˆ
                     else if (currentTurn >= 4 && Math.random() < 0.20) {
                        encounterInstruction = "â˜…é‡è¦æŒ‡ç¤ºï¼šã“ã®æå†™ã®æœ€å¾Œã«ã€çªå¦‚ã¨ã—ã¦æ•µã‚„æ€ªç‰©ãŒç¾ã‚Œã€è¥²ã„æ›ã‹ã‚‹æå†™ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚æ–‡æœ«ã«å¿…ãšã€[BATTLE_START]ã€ã¨å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚";
                     } else {
                        encounterInstruction = "â˜…é‡è¦æŒ‡ç¤ºï¼šæˆ¦é—˜ã¯ç¦æ­¢ã§ã™ã€‚ç’°å¢ƒã®å¤‰åŒ–ã‚„æ¢ç´¢ã®æ§˜å­ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚";
                     }
                } else {
                    encounterInstruction = "â˜…é‡è¦æŒ‡ç¤ºï¼šæˆ¦é—˜ã¯ç¦æ­¢ã§ã™ã€‚ç’°å¢ƒã®å¤‰åŒ–ã‚„æ¢ç´¢ã®æ§˜å­ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚";
                }
            }
            // ---------------------------------------------

            let prompt = "";

            if (currentTurn < MAX_TURNS || isBattleMode) {
                if (isBattleMode) {
                    battleTurnCount++;
                    let battleEndForce = "";
                    if (battleTurnCount >= 2) {
                        battleEndForce = "æˆ¦é—˜ã‚’çµ‚ã‚ã‚‰ã›ã¦ãã ã•ã„ã€‚ä»Šå›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§å¿…ãšæ±ºç€ï¼ˆå‹åˆ©ã¾ãŸã¯é€ƒèµ°ï¼‰ã•ã›ã¦ãã ã•ã„ã€‚";
                    }

                    prompt = `
                    ã‚ãªãŸã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å°èª¬å®¶ã§ã™ã€‚ç¾åœ¨ã€æˆ¦é—˜ä¸­ã€‘ã§ã™ã€‚
                    
                    ã€å ´æ‰€ã€‘${currentZoneName}
                    ã€ç›´å‰ã®çŠ¶æ³ã€‘${lastStory}
                    ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã€‘${playerIntent}
                    
                    ã€åŸ·ç­†ãƒ«ãƒ¼ãƒ«ã€‘
                    1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ•µã®æ”»é˜²ã‚’ã€äº”æ„Ÿï¼ˆéŸ³ã€è¡æ’ƒã€ç—›ã¿ã€åŒ‚ã„ï¼‰ã‚’ä½¿ã£ã¦æå†™ã—ã¦ãã ã•ã„ã€‚
                    2. ${battleEndForce}
                    3. æ±ºç€åˆ¤å®šï¼š
                       - å‹åˆ©/é€ƒèµ° â†’ æ–‡æœ«ã«ã€[BATTLE_END]ã€
                       - æ•—åŒ—/æ­»äº¡ â†’ æ–‡æœ«ã«ã€[GAME_OVER]ã€
                    4. æ±ºç€ãŒã¤ã‹ãªã„å ´åˆã¯ã‚¿ã‚°ã‚’å‡ºã•ãªã„ã§ãã ã•ã„ã€‚
                    5. ã€[BATTLE_START]ã€ã‚¿ã‚°ã¯çµ¶å¯¾ã«å‡ºã•ãªã„ã§ãã ã•ã„ã€‚
                    6. 80ã€œ100æ–‡å­—ç¨‹åº¦ã€‚
                    `;
                } else {
                    prompt = `
                    ã‚ãªãŸã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å°èª¬å®¶ã§ã™ã€‚å…¨${MAX_TURNS}ã‚¿ãƒ¼ãƒ³ä¸­ã®ã€${currentTurn}ã‚¿ãƒ¼ãƒ³ç›®ã€‘ã§ã™ã€‚
                    
                    ã€ç¾åœ¨ã®ã‚¨ãƒªã‚¢ã€‘ã€${currentZoneName}ã€
                    ï¼ˆãƒ†ãƒ¼ãƒ: ${currentThemeData.name}ï¼‰
                    
                    ã€ç›´å‰ã®ç‰©èªã€‘${lastStory}
                    ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã€‘ã€Œ${rawAction}ã€ï¼ˆæ„å›³: ${playerIntent}ï¼‰
                    
                    ã€åŸ·ç­†ãƒ«ãƒ¼ãƒ«ã€‘
                    1. ${zoneChangeInstruction}
                    2. ${transitionInstruction}
                    3. ã€Œã€‡ã€‡ã¸é€²ã‚€ã¨ã€ã¨ã„ã†æ›¸ãå‡ºã—ã¯ç¦æ­¢ã€‚
                    4. äº”æ„Ÿã‚’ä½¿ã£ãŸæå†™ã‚’ã—ã¦ãã ã•ã„ã€‚
                    5. ${encounterInstruction}
                    6. 80ã€œ100æ–‡å­—ç¨‹åº¦ã€‚
                    `;
                }
            } else {
                prompt = `
                ã‚ãªãŸã¯å†’é™ºå°èª¬ã®ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ã“ã‚ŒãŒæœ€çµ‚ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚
                ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€${currentThemeData.name}ã€ã®æœ€å¥¥ã€${currentZoneName}ã€ã¾ã§åˆ°é”ã—ã€ç”Ÿé‚„ã—ã¾ã—ãŸã€‚
                ç‰©èªã‚’ç· ã‚ããã‚‹ã€ä½™éŸ»ã®ã‚ã‚‹ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ã‚’100æ–‡å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚
                `;
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt, history: chatHistory })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                let replyText = data.reply;
                let systemMsg = "";

                if (replyText.includes("[GAME_OVER]")) {
                    isGameOver = true;
                    replyText = replyText.replace("[GAME_OVER]", "").trim();
                    systemMsg = "ğŸ’€ GAME OVER... ã‚ãªãŸã®å†’é™ºã¯çµ‚ã‚ã£ãŸã€‚";
                    document.getElementById('log').style.color = "red";
                    document.getElementById('log').innerText = "YOU DIED";
                }
                else if (replyText.includes("[BATTLE_END]")) {
                    isBattleMode = false;
                    battleCount++; 
                    battleTurnCount = 0; 
                    replyText = replyText.replace("[BATTLE_END]", "").trim();
                    systemMsg = "âœ¨ VICTORY / ESCAPE æˆ¦é—˜çµ‚äº†";
                    document.getElementById('log').style.color = "#00ffea";
                    document.getElementById('log').innerText = "STANDBY...";
                }
                else if (replyText.includes("[BATTLE_START]")) {
                    if (!isBattleMode) {
                        isBattleMode = true;
                        battleTurnCount = 0;
                        replyText = replyText.replace("[BATTLE_START]", "").trim();
                        systemMsg = "âš”ï¸ BATTLE START!! æˆ¦é—˜é–‹å§‹ï¼";
                        document.getElementById('log').style.color = "#ff4444";
                        document.getElementById('log').innerText = "BATTLE MODE";
                    } else {
                        replyText = replyText.replace("[BATTLE_START]", "").trim();
                    }
                }

                storyDiv.innerHTML += `<div class="ai-response">${replyText}</div>`;
                if (systemMsg) {
                    let color = "#00ffea";
                    if (systemMsg.includes("GAME OVER")) color = "red";
                    else if (systemMsg.includes("BATTLE")) color = "#ff4444";
                    storyDiv.innerHTML += `<div class="system-msg" style="color: ${color}; font-weight:bold;">${systemMsg}</div>`;
                }
                scrollToBottom();

                if (chatHistory.length > 6) chatHistory = chatHistory.slice(-6);

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                chatHistory.push({ role: "model", parts: [{ text: replyText }] });

                if (isGameOver) {
                    document.getElementById('reset-btn').style.display = 'inline-block';
                    scrollToBottom();
                    return; 
                }

                if (currentTurn >= MAX_TURNS && !isBattleMode) {
                    isGameOver = true;
                    logEl.innerText = "THE END";
                    logEl.style.color = "#00ffea";
                    document.getElementById('reset-btn').style.display = 'inline-block';
                    scrollToBottom();
                } else {
                    currentTurn++;
                    document.getElementById('turn-display').innerText = `Turn: ${Math.min(currentTurn, MAX_TURNS)} / ${MAX_TURNS}`;
                }

            } catch (err) {
                console.error(err);
                storyDiv.innerHTML += `<div class="error-msg">é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆå†è©¦è¡Œã—ã¦ãã ã•ã„ï¼‰</div>`;
                chatHistory = [];
                scrollToBottom();
            } finally {
                logEl.classList.remove('loading');
                logEl.classList.remove('active');
                if (!isGameOver) {
                    logEl.innerText = isBattleMode ? "BATTLE MODE..." : "STANDBY...";
                }
                setTimeout(() => { isProcessing = false; }, 2000);
            }
        }

        function resetGame() {
            if(!confirm("å†’é™ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) return;
            currentTurn = 1;
            currentThemeData = null;
            lastActionDirection = "";
            isBattleMode = false;
            battleCount = 0; 
            battleTurnCount = 0;
            isGameOver = false;
            chatHistory = []; 
            
            document.getElementById('turn-display').innerText = `Turn: 1 / ${MAX_TURNS}`;
            document.getElementById('log').style.color = "#00ffea";
            document.getElementById('story-area').innerHTML = `
                <p class="system-msg">
                    æœªçŸ¥ã®éºè·¡ã®å…¥ã‚Šå£ã§ç›®ãŒè¦šã‚ãŸ...ã€‚<br>
                    å³ã®ã€Œé­”æ³•é™£ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‹ã‚‰ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã—ã€é‹å‘½ã‚’é¸æŠã›ã‚ˆã€‚
                </p>`;
            document.getElementById('reset-btn').style.display = 'none';
            document.getElementById('log').innerText = "STANDBY...";
            document.getElementById('log').classList.remove('active');
            document.getElementById('log').classList.remove('loading');
        }
    </script>
</body>
</html>