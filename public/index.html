<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sensor Dungeon</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-overlay"></div> 
    
    <div class="main-frame">
        <header class="game-header">
            <h1>AI SENSOR DUNGEON</h1>
            <div id="turn-display" class="turn-badge">Turn: 1 / 10</div>
        </header>

        <main class="game-console">
            <div class="screen-frame">
                <div id="story-area" class="story-log">
                    <p class="system-msg">
                        æš—ã„æ´çªŸã®å…¥ã‚Šå£ã«ç«‹ã£ã¦ã„ã‚‹...ã€‚<br>
                        å³ã®ã€Œé­”æ³•é™£ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‹ã‚‰ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã›ã‚ˆã€‚
                    </p>
                </div>
            </div>

            <div class="controls-area">
                <div class="radar-container">
                    <div class="radar-lines"></div>
                    <div id="dot" class="radar-blip"></div>
                </div>
                
                <div class="status-panel">
                    <div class="qr-wrapper">
                        <p class="qr-label">â–¼ LINK WEAPON â–¼</p>
                        <div id="qrcode"></div>
                    </div>

                    <div id="log" class="action-log">STANDBY...</div>
                    
                    <button id="reset-btn" onclick="resetGame()">ğŸ”„ RESTART</button>
                </div>
            </div>
        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isProcessing = false; 
        let chatHistory = [];
        
        let currentTurn = 1;
        const MAX_TURNS = 10; // â˜…10ã‚¿ãƒ¼ãƒ³ã«æˆ»ã—ã¾ã—ãŸ
        let isGameOver = false;

        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        window.onload = function() {
            const smartUrl = window.location.origin + "/smart.html";
            new QRCode(document.getElementById("qrcode"), {
                text: smartUrl,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        };

        socket.emit('join', 'game');

        socket.on('sensor_update', (data) => {
            updateVisual(data.b, data.g);
            checkAction(data.b, data.g);
        });

        function updateVisual(beta, gamma) {
            const dot = document.getElementById('dot');
            let moveY = beta * 2.5; 
            let moveX = gamma * 2.5;
            const limit = 90;
            moveX = Math.max(-limit, Math.min(limit, moveX));
            moveY = Math.max(-limit, Math.min(limit, moveY));
            dot.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        }

        function checkAction(beta, gamma) {
            if (isProcessing || isGameOver) return; 

            const THRESHOLD = 20; 
            let action = "";

            if (beta < -THRESHOLD) action = "åŒ—ï¼ˆå¥¥ï¼‰ã¸é€²ã‚€";
            else if (beta > THRESHOLD) action = "å—ï¼ˆæ‰‹å‰ï¼‰ã¸æˆ»ã‚‹";
            else if (gamma > THRESHOLD) action = "æ±ï¼ˆå³ï¼‰ã¸é€²ã‚€";
            else if (gamma < -THRESHOLD) action = "è¥¿ï¼ˆå·¦ï¼‰ã¸é€²ã‚€";

            const logEl = document.getElementById('log');
            
            if (action) {
                logEl.innerText = `>> ${action}`;
                logEl.classList.add('active');
                if (!this.holdTimer) {
                    this.holdTimer = setTimeout(() => {
                        sendToAI(action);
                        this.holdTimer = null;
                    }, 1000);
                }
            } else {
                if (this.holdTimer) {
                    clearTimeout(this.holdTimer);
                    this.holdTimer = null;
                    logEl.innerText = "STANDBY...";
                    logEl.classList.remove('active');
                }
            }
        }

        function scrollToBottom() {
            const storyDiv = document.getElementById('story-area');
            storyDiv.scrollTop = storyDiv.scrollHeight;
        }

        async function sendToAI(action) {
            isProcessing = true;
            const storyDiv = document.getElementById('story-area');
            const logEl = document.getElementById('log');
            
            logEl.innerText = "FATE WEAVING...";
            logEl.classList.add('loading');
            
            storyDiv.innerHTML += `<div class="user-action">> ${action}</div>`;
            scrollToBottom();

            // 1. ç›´å‰ã®ç‰©èªã‚’å–å¾—
            let lastStory = "å¤ã„éºè·¡ã®å…¥ã‚Šå£ã§ç›®ãŒè¦šã‚ãŸã€‚è¨˜æ†¶ã¯æ›–æ˜§ã ã€‚";
            if (chatHistory.length > 0) {
                const lastModelPart = chatHistory[chatHistory.length - 1];
                if (lastModelPart.role === "model") {
                    lastStory = lastModelPart.parts[0].text;
                }
            }

            // 2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è§£é‡ˆï¼ˆæ€§æ ¼è¨ºæ–­çš„ãªè¦ç´ ã‚’å…¥ã‚Œã‚‹ï¼‰
            let actionMeaning = "";
            let style = ""; // AIã«ä¼ãˆã‚‹ãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«

            if (action.includes("åŒ—")) {
                actionMeaning = "ã€çªç ´ãƒ»æŒ‘æˆ¦ã€‘å±é™ºã‚’é¡§ã¿ãšã€æ­£é¢ã‹ã‚‰å¥¥ã¸é€²ã‚€";
                style = "å‹‡æ•¢ï¼ˆã‚ã‚‹ã„ã¯ç„¡è¬€ï¼‰";
            } else if (action.includes("å—")) {
                actionMeaning = "ã€æ…é‡ãƒ»æ’¤é€€ã€‘å®‰å…¨ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã€è·é›¢ã‚’å–ã‚‹";
                style = "æ…é‡ï¼ˆã‚ã‚‹ã„ã¯è‡†ç—…ï¼‰";
            } else {
                actionMeaning = "ã€æ¢ç´¢ãƒ»å¥½å¥‡å¿ƒã€‘å‘¨å›²ã‚’èª¿æŸ»ã—ã€æ‰‹ãŒã‹ã‚Šã‚’æ¢ã™";
                style = "å¥½å¥‡å¿ƒæ—ºç››ï¼ˆã‚ã‚‹ã„ã¯æ³¨æ„æ•£æ¼«ï¼‰";
            }

            // 3. ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œï¼ˆ10ã‚¿ãƒ¼ãƒ³ã§ã®èµ·æ‰¿è»¢çµï¼‰
            let stageInstruction = "";
            if (currentTurn <= 3) {
                stageInstruction = "ã€åºç›¤ï¼ˆè¬ï¼‰ã€‘é™å¯‚ãªéºè·¡ã€‚ä¸æ°—å‘³ãªæ°—é…ã‚„ã€è¬ã®æ–‡å­—ãŒè¦‹ã¤ã‹ã‚‹ã€‚æ•µã¯ã¾ã å‡ºã•ãªã„ã€‚";
            } else if (currentTurn <= 8) {
                stageInstruction = "ã€ä¸­ç›¤ï¼ˆè©¦ç·´ï¼‰ã€‘ã€Œå®ˆè­·è€…ã€ã¨å‘¼ã°ã‚Œã‚‹å¹½éœŠã‚„ç½ ãŒç¾ã‚Œã‚‹ã€‚æˆ¦ã†ã‹ã€é¿ã‘ã‚‹ã‹ã€å¯¾è©±ã™ã‚‹ã‹ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¬¡ç¬¬ã€‚";
            } else if (currentTurn < MAX_TURNS) {
                stageInstruction = "ã€çµ‚ç›¤ï¼ˆé¸æŠï¼‰ã€‘å‡ºå£ã¨ãŠã¼ã—ãå…‰ãŒè¦‹ãˆã‚‹ãŒã€å·¨å¤§ãªå½±ãŒç«‹ã¡ã¯ã ã‹ã‚‹ã€‚";
            } else {
                stageInstruction = "ã€çµæœ«ã€‘";
            }

            let prompt = "";

            if (currentTurn < MAX_TURNS) {
                // é€šå¸¸ã‚¿ãƒ¼ãƒ³
                prompt = `
                ã‚ãªãŸã¯ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒ›ãƒ©ãƒ¼RPGã®GMã§ã™ã€‚
                å…¨${MAX_TURNS}ã‚¿ãƒ¼ãƒ³ä¸­ã®ã€${currentTurn}ã‚¿ãƒ¼ãƒ³ç›®ã€‘ã§ã™ã€‚
                
                ã€ç›´å‰ã®ç‰©èªã€‘
                ${lastStory}
                
                ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã€‘
                æ“ä½œ: ã€Œ${action}ã€
                æ„å›³: ${actionMeaning}
                ï¼ˆãƒ—ãƒ¬ã‚¤ã‚¹ã‚¿ã‚¤ãƒ«: ${style}ï¼‰
                
                ã€çµ¶å¯¾çš„ãªæŒ‡ç¤ºã€‘
                1. ç›´å‰ã®æ–‡è„ˆã‚’å¼•ãç¶™ãã€éºè·¡ã®å¥¥ã¸ï¼ˆã¾ãŸã¯å‡ºå£ã¸ï¼‰èª˜å°ã—ã¦ãã ã•ã„ã€‚
                2. ã€ŒåŒ—ã€ã‚’é¸ã‚“ã ã‚‰ç‰©ç†çš„ãªè§£æ±ºï¼ˆæ‰‰ã‚’è¹´ç ´ã‚‹ã€æ•µã‚’æ®´ã‚‹ï¼‰ã‚’æå†™ã€‚
                3. ã€Œæ±è¥¿ã€ã‚’é¸ã‚“ã ã‚‰çŸ¥çš„ãªè§£æ±ºï¼ˆè¬ã‚’è§£ãã€æŠœã‘é“ã‚’è¦‹ã¤ã‘ã‚‹ï¼‰ã‚’æå†™ã€‚
                4. ã€Œå—ã€ã‚’é¸ã‚“ã ã‚‰å›é¿è¡Œå‹•ã‚’æå†™ã€‚
                5. 50ã€œ80æ–‡å­—ç¨‹åº¦ã®å°èª¬é¢¨æå†™ã€‚
                `;
            } else {
                // æœ€çµ‚ã‚¿ãƒ¼ãƒ³ï¼ˆæ€§æ ¼è¨ºæ–­ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
                prompt = `
                ã‚ãªãŸã¯RPGã®ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ã“ã‚ŒãŒæœ€çµ‚ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ç‰©èªã‚’å®Œçµã•ã›ã¦ãã ã•ã„ã€‚
                
                ã€ã“ã‚Œã¾ã§ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‚¾å‘ã€‘
                ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯10ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ§˜ã€…ãªé¸æŠã‚’ã—ã¦ãã¾ã—ãŸã€‚
                å±¥æ­´ï¼ˆHistoryï¼‰ã‚’å‚ç…§ã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œå‹‡æ•¢ã ã£ãŸã‹ã€ã€Œæ…é‡ã ã£ãŸã‹ã€ã€Œè³¢ã‹ã£ãŸã‹ã€ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
                
                ã€æŒ‡ç¤ºã€‘
                ãã®åˆ¤æ–­ã«åŸºã¥ãã€ä»¥ä¸‹ã®ã©ã‚Œã‹ã®çµæœ«ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                A. å‹‡æ•¢ï¼ˆåŒ—ãŒå¤šã„ï¼‰â†’ã€Œæ­¦äººã®çµæœ«ã€ï¼šæ•µã‚’å€’ã—è‹±é›„ã¨ã—ã¦ç”Ÿé‚„ã™ã‚‹ãŒã€æˆ¦ã„ã®å‚·è·¡ã¯æ®‹ã‚‹ã€‚
                B. æ…é‡ï¼ˆå—ãŒå¤šã„ï¼‰â†’ã€Œç”Ÿé‚„è€…ã®çµæœ«ã€ï¼šä½•ã‚‚å¾—ã‚‰ã‚Œãªã‹ã£ãŸãŒã€ç„¡å‚·ã§æ—¥å¸¸ã«æˆ»ã‚‹ã€‚
                C. çŸ¥çš„ï¼ˆæ±è¥¿ãŒå¤šã„ï¼‰â†’ã€Œæ¢æ±‚è€…ã®çµæœ«ã€ï¼šéºè·¡ã®ç§˜å®ã‚„çœŸå®Ÿã‚’æŒã¡å¸°ã‚‹ã€‚
                D. ã©ã£ã¡ã¤ã‹ãš â†’ã€Œè¿·å®®ã®çµæœ«ã€ï¼šéºè·¡ã®é—‡ã«å–ã‚Šè¾¼ã¾ã‚Œã€è¡Œæ–¹ä¸æ˜ã«ãªã‚‹ã€‚
                
                100æ–‡å­—ç¨‹åº¦ã®ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                `;
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt, history: chatHistory })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                storyDiv.innerHTML += `<div class="ai-response">${data.reply}</div>`;
                scrollToBottom();
                
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                chatHistory.push({ role: "model", parts: [{ text: data.reply }] });

                if (currentTurn >= MAX_TURNS) {
                    isGameOver = true;
                    logEl.innerText = "FINALE";
                    document.getElementById('reset-btn').style.display = 'inline-block';
                    scrollToBottom();
                } else {
                    currentTurn++;
                    document.getElementById('turn-display').innerText = `Turn: ${currentTurn} / ${MAX_TURNS}`;
                }

            } catch (err) {
                console.error(err);
                storyDiv.innerHTML += `<div class="error-msg">é€šä¿¡ã‚¨ãƒ©ãƒ¼: æ™‚é–“ã‚’ãŠã„ã¦è©¦ã—ã¦ãã ã•ã„</div>`;
                scrollToBottom();
            } finally {
                logEl.classList.remove('loading');
                logEl.classList.remove('active');
                if (!isGameOver) logEl.innerText = "STANDBY...";
                setTimeout(() => { isProcessing = false; }, 2000);
            }
        }
        
        function resetGame() {
            if(!confirm("å†’é™ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) return;
            currentTurn = 1;
            isGameOver = false;
            chatHistory = []; 
            document.getElementById('turn-display').innerText = `Turn: 1 / ${MAX_TURNS}`;
            document.getElementById('story-area').innerHTML = `
                <p class="system-msg">
                    å¤ã„éºè·¡ã®å…¥ã‚Šå£ã§ç›®ãŒè¦šã‚ãŸ...ã€‚<br>
                    å³ã®ã€Œé­”æ³•é™£ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‹ã‚‰ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã—ã€é‹å‘½ã‚’é¸æŠã›ã‚ˆã€‚
                </p>`;
            document.getElementById('reset-btn').style.display = 'none';
            document.getElementById('log').innerText = "STANDBY...";
            document.getElementById('log').classList.remove('active');
            document.getElementById('log').classList.remove('loading');
        }
    </script>
</body>
</html>