<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sensor Dungeon</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-overlay"></div> 
    
    <div class="main-frame">
        <header class="game-header">
            <h1>AI SENSOR DUNGEON</h1>
            <div id="turn-display" class="turn-badge">Turn: 1 / 10</div>
        </header>

        <main class="game-console">
            <div class="screen-frame">
                <div id="story-area" class="story-log">
                    <p class="system-msg">
                        æš—ã„æ´çªŸã®å…¥ã‚Šå£ã«ç«‹ã£ã¦ã„ã‚‹...ã€‚<br>
                        å³ã®ã€Œé­”æ³•é™£ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‹ã‚‰ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã›ã‚ˆã€‚
                    </p>
                </div>
            </div>

            <div class="controls-area">
                <div class="radar-container">
                    <div class="radar-lines"></div>
                    <div id="dot" class="radar-blip"></div>
                </div>
                
                <div class="status-panel">
                    <div class="qr-wrapper">
                        <p class="qr-label">â–¼ LINK WEAPON â–¼</p>
                        <div id="qrcode"></div>
                    </div>

                    <div id="log" class="action-log">STANDBY...</div>
                    
                    <button id="reset-btn" onclick="resetGame()">ğŸ”„ RESTART</button>
                </div>
            </div>
        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isProcessing = false; 
        let chatHistory = [];
        let currentTurn = 1;
        const MAX_TURNS = 10;
        let isGameOver = false;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        window.onload = function() {
            const smartUrl = window.location.origin + "/smart.html";
            console.log("ã‚¹ãƒãƒ›ç”¨URL:", smartUrl);
            new QRCode(document.getElementById("qrcode"), {
                text: smartUrl,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        };

        socket.emit('join', 'game');

        socket.on('sensor_update', (data) => {
            updateVisual(data.b, data.g);
            checkAction(data.b, data.g);
        });

        function updateVisual(beta, gamma) {
            const dot = document.getElementById('dot');
            let moveY = beta * 2.5; 
            let moveX = gamma * 2.5;
            const limit = 90;
            moveX = Math.max(-limit, Math.min(limit, moveX));
            moveY = Math.max(-limit, Math.min(limit, moveY));
            dot.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        }

        function checkAction(beta, gamma) {
            // å‡¦ç†ä¸­ã¾ãŸã¯ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (isProcessing || isGameOver) return; 

            const THRESHOLD = 20; 
            let action = "";

            if (beta < -THRESHOLD) action = "åŒ—ï¼ˆå¥¥ï¼‰ã¸é€²ã‚€";
            else if (beta > THRESHOLD) action = "å—ï¼ˆæ‰‹å‰ï¼‰ã¸æˆ»ã‚‹";
            else if (gamma > THRESHOLD) action = "æ±ï¼ˆå³ï¼‰ã¸é€²ã‚€";
            else if (gamma < -THRESHOLD) action = "è¥¿ï¼ˆå·¦ï¼‰ã¸é€²ã‚€";

            const logEl = document.getElementById('log');
            
            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæ¤œçŸ¥ã•ã‚ŒãŸå ´åˆ
            if (action) {
                logEl.innerText = `>> ${action}`;
                logEl.classList.add('active');
                
                if (!this.holdTimer) {
                    this.holdTimer = setTimeout(() => {
                        sendToAI(action);
                        this.holdTimer = null;
                    }, 1000);
                }
            } else {
                // å‚¾ããŒæˆ»ã£ãŸå ´åˆ
                if (this.holdTimer) {
                    clearTimeout(this.holdTimer);
                    this.holdTimer = null;
                    logEl.innerText = "STANDBY...";
                    logEl.classList.remove('active');
                }
            }
        }

        function scrollToBottom() {
            const storyDiv = document.getElementById('story-area');
            storyDiv.scrollTop = storyDiv.scrollHeight;
        }

        async function sendToAI(action) {
            isProcessing = true;
            const storyDiv = document.getElementById('story-area');
            const logEl = document.getElementById('log');
            
            // â˜…é‡è¦ä¿®æ­£ï¼šLOADINGè¡¨ç¤ºã‚’logè¦ç´ ã§è¡Œã†
            logEl.innerText = "FATE WEAVING...";
            logEl.classList.add('loading');
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            storyDiv.innerHTML += `<div class="user-action">> ${action}</div>`;
            scrollToBottom();

            let prompt = "";
            if (currentTurn < MAX_TURNS) {
                prompt = `ã‚ãªãŸã¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼RPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚ç¾åœ¨ã¯å…¨${MAX_TURNS}ã‚¿ãƒ¼ãƒ³ä¸­ã®ã€${currentTurn}ã‚¿ãƒ¼ãƒ³ç›®ã€‘ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ï¼šã€Œ${action}ã€ã€‚ã€æŒ‡ç¤ºã€‘æ—¥æœ¬èªã§å‡ºåŠ›ã€‚ãƒ¡ã‚¿ç™ºè¨€ç¦æ­¢ã€‚æ–‡è„ˆã‚’è¸ã¾ãˆã€è¡Œå‹•ã®çµæœã‚’ãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ã«50ã€œ80æ–‡å­—ã§æå†™ã€‚`;
            } else {
                prompt = `ã‚ãªãŸã¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼RPGã®ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚ã“ã‚ŒãŒã€æœ€çµ‚ã‚¿ãƒ¼ãƒ³ï¼ˆ${MAX_TURNS}/${MAX_TURNS}ï¼‰ã€‘ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ï¼šã€Œ${action}ã€ã€‚ã€æŒ‡ç¤ºã€‘æ—¥æœ¬èªã§å‡ºåŠ›ã€‚ç‰©èªã‚’å®Œçµã•ã›ã‚‹ã€‚ç®‡æ¡æ›¸ãç¦æ­¢ã€‚`;
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt, history: chatHistory })
                });
                
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                
                storyDiv.innerHTML += `<div class="ai-response">${data.reply}</div>`;
                scrollToBottom();
                
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                chatHistory.push({ role: "model", parts: [{ text: data.reply }] });

                if (currentTurn >= MAX_TURNS) {
                    isGameOver = true;
                    logEl.innerText = "QUEST CLEAR";
                    document.getElementById('reset-btn').style.display = 'inline-block';
                    scrollToBottom();
                } else {
                    currentTurn++;
                    document.getElementById('turn-display').innerText = `Turn: ${currentTurn} / ${MAX_TURNS}`;
                }

            } catch (err) {
                console.error(err);
                storyDiv.innerHTML += `<div class="error-msg">é€šä¿¡ã‚¨ãƒ©ãƒ¼: å†è©¦è¡Œã—ã¦ãã ã•ã„</div>`;
                scrollToBottom();
            } finally {
                // å‡¦ç†å®Œäº†å¾Œã®ãƒªã‚»ãƒƒãƒˆ
                logEl.classList.remove('loading');
                logEl.classList.remove('active');
                
                if (!isGameOver) {
                    logEl.innerText = "STANDBY...";
                }
                
                setTimeout(() => { isProcessing = false; }, 2000);
            }
        }

        function resetGame() {
            if(!confirm("å†’é™ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) return;
            currentTurn = 1;
            isGameOver = false;
            chatHistory = []; 
            document.getElementById('turn-display').innerText = `Turn: 1 / ${MAX_TURNS}`;
            document.getElementById('story-area').innerHTML = `
                <p class="system-msg">
                    æš—ã„æ´çªŸã®å…¥ã‚Šå£ã«ç«‹ã£ã¦ã„ã‚‹...ã€‚<br>
                    å³ã®ã€Œé­”æ³•é™£ï¼ˆQRã‚³ãƒ¼ãƒ‰ï¼‰ã€ã‹ã‚‰ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã›ã‚ˆã€‚
                </p>`;
            document.getElementById('reset-btn').style.display = 'none';
            document.getElementById('log').innerText = "STANDBY...";
            document.getElementById('log').classList.remove('active');
            document.getElementById('log').classList.remove('loading');
        }
    </script>
</body>
</html>