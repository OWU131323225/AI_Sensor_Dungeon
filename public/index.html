<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sensor Dungeon</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="bg-overlay"></div> <div class="main-frame">
        <header class="game-header">
            <h1>AI SENSOR DUNGEON</h1>
            <div id="turn-display" class="turn-badge">Turn: 1 / 10</div>
        </header>

        <main class="game-console">
            <div class="screen-frame">
                <div id="story-area" class="story-log">
                    <p class="system-msg">
                        æš—ã„æ´çªŸã®å…¥ã‚Šå£ã«ç«‹ã£ã¦ã„ã‚‹...ã€‚<br>
                        æ‰‹å…ƒã®ã€Œç¾…é‡ç›¤ï¼ˆã‚¹ãƒãƒ›ï¼‰ã€ã‚’å‚¾ã‘ã¦é€²ã‚€æ–¹å‘ã‚’æ±ºã‚ã‚ˆã†ã€‚
                    </p>
                </div>
            </div>

            <div class="controls-area">
                <div class="radar-container">
                    <div class="radar-lines"></div>
                    <div id="dot" class="radar-blip"></div>
                </div>
                
                <div class="status-panel">
                    <div id="loading" class="loading-text">FATE WEAVING...</div>
                    <div id="log" class="action-log">LINK WAITING...</div>
                    <button id="reset-btn" onclick="resetGame()">ğŸ”„ RESTART</button>
                </div>
            </div>
        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isProcessing = false; 
        let chatHistory = [];
        
        let currentTurn = 1;
        const MAX_TURNS = 10;
        let isGameOver = false;

        // ã‚²ãƒ¼ãƒ ç”¨ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
        socket.emit('join', 'game');

        // ã‚¹ãƒãƒ›ã‹ã‚‰ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
        socket.on('sensor_update', (data) => {
            updateVisual(data.b, data.g);
            checkAction(data.b, data.g);
        });

        // ãƒ‰ãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°ï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼è¡¨ç¤ºï¼‰
        function updateVisual(beta, gamma) {
            const dot = document.getElementById('dot');
            // æ„Ÿåº¦èª¿æ•´
            let moveY = beta * 2.5; 
            let moveX = gamma * 2.5;
            
            // å††ã®ä¸­ã«åã‚ã‚‹åˆ¶é™
            const limit = 90;
            moveX = Math.max(-limit, Math.min(limit, moveX));
            moveY = Math.max(-limit, Math.min(limit, moveY));
            
            dot.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        }

        // å‚¾ãåˆ¤å®š
        function checkAction(beta, gamma) {
            if (isProcessing || isGameOver) return; 

            const THRESHOLD = 20; 
            let action = "";

            if (beta < -THRESHOLD) action = "åŒ—ï¼ˆå¥¥ï¼‰ã¸é€²ã‚€";
            else if (beta > THRESHOLD) action = "å—ï¼ˆæ‰‹å‰ï¼‰ã¸æˆ»ã‚‹";
            else if (gamma > THRESHOLD) action = "æ±ï¼ˆå³ï¼‰ã¸é€²ã‚€";
            else if (gamma < -THRESHOLD) action = "è¥¿ï¼ˆå·¦ï¼‰ã¸é€²ã‚€";

            const logEl = document.getElementById('log');
            
            if (action) {
                logEl.innerText = `>> ${action}`;
                logEl.classList.add('active'); // å…‰ã‚‰ã›ã‚‹
                
                if (!this.holdTimer) {
                    this.holdTimer = setTimeout(() => {
                        sendToAI(action);
                        this.holdTimer = null;
                    }, 1000);
                }
            } else {
                if (this.holdTimer) {
                    clearTimeout(this.holdTimer);
                    this.holdTimer = null;
                    logEl.innerText = "STANDBY...";
                    logEl.classList.remove('active');
                }
            }
        }

        // --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢æ•° ---
        function scrollToBottom() {
            const storyDiv = document.getElementById('story-area');
            storyDiv.scrollTop = storyDiv.scrollHeight;
        }

        // AIã¸é€ä¿¡
        async function sendToAI(action) {
            isProcessing = true;
            const storyDiv = document.getElementById('story-area');
            const loadingDiv = document.getElementById('loading');
            
            loadingDiv.style.display = 'block';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            storyDiv.innerHTML += `<div class="user-action">> ${action}</div>`;
            scrollToBottom();

            let prompt = "";
            
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã¸ã®å‘½ä»¤ï¼‰ã‚’ä½œæˆ
            if (currentTurn < MAX_TURNS) {
                // é€šå¸¸ã‚¿ãƒ¼ãƒ³
                prompt = `
                ã‚ãªãŸã¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼RPGã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ï¼ˆãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ã§ã™ã€‚
                ç¾åœ¨ã¯å…¨${MAX_TURNS}ã‚¿ãƒ¼ãƒ³ä¸­ã®ã€${currentTurn}ã‚¿ãƒ¼ãƒ³ç›®ã€‘ã§ã™ã€‚
                ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ï¼šã€Œ${action}ã€
                
                ã€çµ¶å¯¾çš„ãªæŒ‡ç¤ºã€‘
                1. å¿…ãšã€æ—¥æœ¬èªã€‘ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                2. ã€Œæ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€ã‚„ã€Œæ¬¡ã¯ã©ã†ã—ã¾ã™ã‹ï¼Ÿã€ãªã©ã®æŒ¨æ‹¶ãƒ»ãƒ¡ã‚¿ç™ºè¨€ã¯ç¦æ­¢ã§ã™ã€‚
                3. ã“ã‚Œã¾ã§ã®æ–‡è„ˆï¼ˆhistoryï¼‰ã‚’è¸ã¾ãˆã€è¡Œå‹•ã®çµæœã‚’å°èª¬é¢¨ã®æ–‡ç« ï¼ˆ50ã€œ80æ–‡å­—ç¨‹åº¦ï¼‰ã§æå†™ã—ã¦ãã ã•ã„ã€‚
                4. é›°å›²æ°—ã¯ã€Œãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã€ã§ã€è¬ã‚ã„ãŸè¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
                `;
            } else {
                // æœ€çµ‚ã‚¿ãƒ¼ãƒ³
                prompt = `
                ã‚ãªãŸã¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼RPGã®ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚
                ã“ã‚ŒãŒã€æœ€çµ‚ã‚¿ãƒ¼ãƒ³ï¼ˆ${MAX_TURNS}/${MAX_TURNS}ï¼‰ã€‘ã§ã™ã€‚
                ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ï¼šã€Œ${action}ã€
                
                ã€çµ¶å¯¾çš„ãªæŒ‡ç¤ºã€‘
                1. å¿…ãšã€æ—¥æœ¬èªã€‘ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                2. ã“ã®è¡Œå‹•ã«ã‚ˆã£ã¦ç‰©èªã‚’å®Œçµã•ã›ã¦ãã ã•ã„ï¼ˆBad Endã§ã‚‚Good Endã§ã‚‚å¯ï¼‰ã€‚
                3. ã€Œå†’é™ºã®è¨˜éŒ²ã€ãªã©ã®ç®‡æ¡æ›¸ãã¯ç¦æ­¢ã€‚ã‚ãã¾ã§ç‰©èªã®æ–‡ç« ï¼ˆã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ï¼‰ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                `;
            }

            try {
                // historyã‚’å«ã‚ã¦é€ä¿¡
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt, history: chatHistory })
                });
                
                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }
                
                // AIã®è¿”ç­”ã‚’è¡¨ç¤ºã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                storyDiv.innerHTML += `<div class="ai-response">${data.reply}</div>`;
                scrollToBottom();
                
                // å±¥æ­´ã«è¿½åŠ 
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                chatHistory.push({ role: "model", parts: [{ text: data.reply }] });

                // ã‚¿ãƒ¼ãƒ³æ›´æ–°å‡¦ç†
                if (currentTurn >= MAX_TURNS) {
                    isGameOver = true;
                    document.getElementById('log').innerText = "QUEST CLEAR";
                    document.getElementById('reset-btn').style.display = 'inline-block';
                    scrollToBottom();
                } else {
                    currentTurn++;
                    document.getElementById('turn-display').innerText = `Turn: ${currentTurn} / ${MAX_TURNS}`;
                }

            } catch (err) {
                console.error(err);
                storyDiv.innerHTML += `<div class="error-msg">é€šä¿¡ã‚¨ãƒ©ãƒ¼: æ··ã¿åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„</div>`;
                scrollToBottom();
            } finally {
                loadingDiv.style.display = 'none';
                setTimeout(() => { isProcessing = false; }, 2000);
            }
        }

        // ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function resetGame() {
            if(!confirm("å†’é™ºã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) return;
            
            currentTurn = 1;
            isGameOver = false;
            chatHistory = []; 
            
            // UIã®ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('turn-display').innerText = `Turn: 1 / ${MAX_TURNS}`;
            document.getElementById('story-area').innerHTML = `
                <p class="system-msg">
                    æš—ã„æ´çªŸã®å…¥ã‚Šå£ã«ç«‹ã£ã¦ã„ã‚‹...ã€‚<br>
                    æ‰‹å…ƒã®ã€Œç¾…é‡ç›¤ï¼ˆã‚¹ãƒãƒ›ï¼‰ã€ã‚’å‚¾ã‘ã¦é€²ã‚€æ–¹å‘ã‚’æ±ºã‚ã‚ˆã†ã€‚
                </p>`;
            document.getElementById('reset-btn').style.display = 'none';
            document.getElementById('log').innerText = "STANDBY...";
            document.getElementById('log').classList.remove('active');
        }
    </script>
</body>
</html>